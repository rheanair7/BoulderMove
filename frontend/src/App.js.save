<PlaceAutocomplete
  onPlaceChanged={(place) => {
    // `place` is a full PlaceResult object
    handleOriginSelect(place);
  }}
>
  {({ suggestions, setValue, value, clearSuggestions }) => (
    <div className="autocomplete-container">
      <input
        value={value}
        onChange={(e) => setValue(e.target.value)}
        placeholder="Enter origin"
        className="input-class"
      />

      {/* Dropdown */}
      {suggestions?.length > 0 && (
        <ul className="autocomplete-dropdown">
          {suggestions.map((suggestion) => (
            <li
              key={suggestion.place_id}
              onClick={() => {
                setValue(suggestion.description, false);
                clearSuggestions();
              }}
            >
              {suggestion.description}
            </li>
          ))}
        </ul>
      )}
    </div>
  )}
</PlaceAutocomplete>
import { DotLottieReact } from "@lottiefiles/dotlottie-react";
import React, { useState, useEffect, useCallback, useRef } from "react";
import {
  GoogleMap,
  Polyline,
  Marker,
  useJsApiLoader,
  Autocomplete,
  PlaceAutocomplete,
} from "@react-google-maps/api";
import polyline from "@mapbox/polyline";

/* ---------------- MAP STYLE ---------------- */
const mapContainerStyle = {
  width: "100%",
  height: "520px",
  borderRadius: "14px",
  boxShadow: "0 3px 12px rgba(0,0,0,0.20)",
  overflow: "hidden",
};

const mapOptions = {
  disableDefaultUI: false,
  zoomControl: true,
  streetViewControl: false,
  fullscreenControl: true,
  mapTypeControl: false,
};

/* -------- Shared Layout Styles -------- */
const topBarStyle = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  padding: "16px 24px",
  background: "white",
  borderBottom: "1px solid #e2e2e7",
};

const mainLayoutStyle = {
  display: "grid",
  gridTemplateColumns: "320px 1.5fr 1fr",
  gap: "16px",
  padding: "16px 24px",
};

const leftPanelStyle = {
  background: "white",
  borderRadius: "12px",
  padding: "16px",
  boxShadow: "0 2px 8px rgba(0,0,0,0.06)",
};

const centerPanelStyle = {
  background: "white",
  borderRadius: "12px",
  padding: "8px",
  boxShadow: "0 2px 8px rgba(0,0,0,0.06)",
};

const rightPanelStyle = {
  background: "white",
  borderRadius: "12px",
  padding: "16px",
  boxShadow: "0 2px 8px rgba(0,0,0,0.06)",
  display: "flex",
  flexDirection: "column",
  gap: "8px",
  maxHeight: "600px",
  overflowY: "auto",
};

const bottomStripStyle = {
  marginTop: "8px",
  padding: "8px 24px 18px",
  fontSize: "14px",
  color: "#555",
};

/* Chip buttons */
const chipStyle = {
  fontSize: "12px",
  padding: "4px 10px",
  borderRadius: "999px",
  border: "1px solid #ddd",
  background: "white",
  cursor: "pointer",
};

/* Input styles */
const inputStyle = {
  padding: "10px",
  borderRadius: "8px",
  border: "1px solid #ccc",
  fontSize: "14px",
};

const inputStyleLarge = {
  flex: 2,
  padding: "12px",
  borderRadius: "8px",
  border: "1px solid #ccc",
};

const selectStyle = {
  padding: "10px",
  borderRadius: "8px",
  border: "1px solid #ccc",
  minWidth: "150px",
  fontSize: "14px",
};

/* ---------------- MAIN COMPONENT ---------------- */
export default function App() {
  const [showLanding, setShowLanding] = useState(true);
  const [landingFadeOut, setLandingFadeOut] = useState(false);

  const hideLanding = () => {
    setLandingFadeOut(true);
    setTimeout(() => setShowLanding(false), 600);
  };

  useEffect(() => {
    const t = setTimeout(hideLanding, 2800);
    return () => clearTimeout(t);
  }, []);

  const [origin, setOrigin] = useState("norlin library");
  const [destination, setDestination] = useState("Denver, CO");
  const [stops, setStops] = useState("");
  const [mode, setMode] = useState("driving");
  const [showAlternatives, setShowAlternatives] = useState(false);
  const [routes, setRoutes] = useState([]);
  const [showWeatherDetails, setShowWeatherDetails] = useState(true);
  const [originCoords, setOriginCoords] = useState(null);
  const [destinationCoords, setDestinationCoords] = useState(null);

  const mapRef = useRef(null);
  const originAutoRef = useRef(null);
  const destAutoRef = useRef(null);
  const stopsAutoRef = useRef(null);

  const clearOldRoute = () => setRoutes([]);

/* Load Google Maps API */
  const { isLoaded } = useJsApiLoader({
  googleMapsApiKey: process.env.REACT_APP_GOOGLE_MAPS_API_KEY,
  libraries: ["places"],
});
  /* ---------------- AUTOCOMPLETE HANDLERS ---------------- */
  const handleOriginSelect = () => {
    const place = originAutoRef.current?.getPlace();
    if (!place) return;

    if (place.formatted_address) setOrigin(place.formatted_address);

    if (place.geometry?.location) {
      const loc = place.geometry.location;
      setOriginCoords({ lat: loc.lat(), lon: loc.lng() });
    }
  };

  const handleDestinationSelect = () => {
    const place = destAutoRef.current?.getPlace();
    if (!place) return;

    if (place.formatted_address) setDestination(place.formatted_address);

    if (place.geometry?.location) {
      const loc = place.geometry.location;
      setDestinationCoords({ lat: loc.lat(), lon: loc.lng() });
    }
  };

  const handleStopSelect = () => {
    const place = stopsAutoRef.current?.getPlace();
    if (place?.formatted_address) {
      setStops((prev) =>
        prev ? prev + "; " + place.formatted_address : place.formatted_address
      );
    }
  };

  /* -------- Time parser for HH:MM:SS ‚Üí seconds -------- */
  const parseHHMMSS = (t) => {
    if (!t) return null;
    const [h, m, s] = t.split(":").map(Number);
    return h * 3600 + m * 60 + (s || 0);
  };

  /* ---------------- MAIN BACKEND REQUEST ---------------- */
  const fetchRoute = useCallback(
    async () => {
      console.log("üöÄ FETCH ROUTE CALLED", { mode, originCoords, destinationCoords });

      if (mode !== "transit") return;
      if (!originCoords || !destinationCoords) return;

      clearOldRoute();

      const body = {
        origin: { lat: originCoords.lat, lon: originCoords.lon },
        destination: { lat: destinationCoords.lat, lon: destinationCoords.lon },
        depart_at: new Date().toISOString(),
      };

      try {
        const res = await fetch(
          `${process.env.REACT_APP_COMBINED_ROUTER_URL}/plan_transit_full`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          }
        );

        if (!res.ok) {
          console.error("Transit API error:", await res.text());
          return;
        }

        const data = await res.json();
        const legs = data.transit?.legs || [];

        let durationMin = null;
        if (legs.length > 0) {
          const firstDep = parseHHMMSS(legs[0].departure);
          const lastArr = parseHHMMSS(legs[legs.length - 1].arrival);
          if (firstDep != null && lastArr != null) {
            durationMin = (lastArr - firstDep) / 60;
          }
        }

        const totalWalkM =
          (data.origin_walk?.distance_m || 0) +
          (data.destination_walk?.distance_m || 0);

        const summary =
          legs.length > 0
            ? `Walk ‚Üí Transit (${legs[0].route_id || legs[0].trip_id}) ‚Üí Walk`
            : "Walk + transit";

        const polylineCoords = [
          ...(data.origin_walk?.path || []).map((p) => ({
            lat: p.lat,
            lng: p.lon,
          })),
          ...(data.destination_walk?.path || []).map((p) => ({
            lat: p.lat,
            lng: p.lon,
          })),
        ];

        const routeObj = {
          summary,
          duration_min: durationMin,
          distance_km: totalWalkM / 1000,
          polyline: null,
          polylineCoords,
          start_location: {
            lat: data.origin.lat,
            lng: data.origin.lon,
          },
          end_location: {
            lat: data.destination.lat,
            lng: data.destination.lon,
          },
          waypoint_locations: [],
          stops: legs.flatMap((l) => l.intermediate_stops || []),
          weather: null,
          alerts: null,
          events_nearby: [],
          transit_raw: data,
        };

        setRoutes([routeObj]);
      } catch (err) {
        console.error("Fetch error:", err);
      }
    },
    [mode, originCoords, destinationCoords]
  );

  /* Auto-run fetchRoute on state changes */
  useEffect(() => {
    if (mode === "transit") {
      const timer = setTimeout(fetchRoute, 400);
      return () => clearTimeout(timer);
    }
  }, [fetchRoute, mode]);




  /* -------- Decode Polylines or use custom coords -------- */
  const decodedRoutes = routes.map((r) => {
    if (r.polylineCoords && r.polylineCoords.length > 0) {
      return r.polylineCoords;
    }
    if (r.polyline) {
      return polyline.decode(r.polyline).map(([lat, lng]) => ({ lat, lng }));
    }
    return [];
  });

  /* -------- Build route markers -------- */
  const buildMarkers = () => {
    if (routes.length === 0) return [];
    const r = routes[0];
    const markers = [];
    if (r.start_location) markers.push({ position: r.start_location });
    if (r.waypoint_locations)
      r.waypoint_locations.forEach((wp) => markers.push({ position: wp }));
    if (r.end_location) markers.push({ position: r.end_location });
    return markers;
  };

  /* -------- Fit map to route -------- */
  useEffect(() => {
    if (!isLoaded || !mapRef.current || decodedRoutes.length === 0) return;
    const bounds = new window.google.maps.LatLngBounds();
    decodedRoutes.forEach((path) => path.forEach((p) => bounds.extend(p)));
    mapRef.current.fitBounds(bounds);
  }, [decodedRoutes, isLoaded]);

  /* ---------------- UI ---------------- */
  if (!isLoaded) {
    return (
      <div style={{ textAlign: "center", padding: "200px 0" }}>
        Loading map...
      </div>
    );
  }

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "#f5f5f8",
        position: "relative",
        overflow: "hidden",
      }}
    >
      {/* FULL-SCREEN LANDING OVERLAY */}
      {showLanding && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 1000,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            background:
              "radial-gradient(circle at top, #fdfbfb 0, #ebedee 40%, #dfe7fd 100%)",
            opacity: landingFadeOut ? 0 : 1,
            transform: landingFadeOut ? "scale(1.02)" : "scale(1)",
            transition: "opacity 600ms ease, transform 600ms ease",
          }}
        >
          <div
            style={{
              background: "rgba(255,255,255,0.95)",
              borderRadius: "20px",
              padding: "32px 40px",
              boxShadow: "0 18px 60px rgba(15,23,42,0.18)",
              maxWidth: "540px",
              width: "90%",
              display: "flex",
              gap: 24,
              alignItems: "center",
            }}
          >
            <div style={{ width: 96, height: 96 }}>
              <DotLottieReact
                src="https://lottie.host/5a79cff1-423a-4aa6-824f-954dca862994/ezy8pcAi40.lottie"
                loop
                autoplay
                style={{ width: "96px", height: "96px" }}
              />
            </div>

            <div>
              <h1
                style={{
                  margin: "0 0 8px",
                  fontSize: "32px",
                  fontWeight: 700,
                }}
              >
                BoulderMove
              </h1>
              <p
                style={{
                  margin: "0 0 12px",
                  fontSize: "15px",
                  color: "#4b5563",
                }}
              >
                Smart, weather-aware trip planning for Boulder and beyond.
              </p>

              <div
                style={{
                  display: "flex",
                  flexWrap: "wrap",
                  gap: 8,
                  fontSize: "13px",
                  marginBottom: 16,
                  color: "#4b5563",
                }}
              >
                <span>üöå Transit + üö∂ walking</span>
                <span>‚òÅÔ∏è Live weather context</span>
                <span>üìä Route insights</span>
              </div>

              <button
                onClick={hideLanding}
                style={{
                  padding: "10px 18px",
                  borderRadius: "999px",
                  border: "none",
                  background:
                    "linear-gradient(135deg, #2563eb 0%, #4f46e5 100%)",
                  color: "white",
                  fontSize: "14px",
                  fontWeight: 600,
                  cursor: "pointer",
                  boxShadow: "0 10px 30px rgba(37,99,235,0.35)",
                }}
              >
                Enter BoulderMove
              </button>

              <div
                style={{
                  marginTop: 8,
                  fontSize: "12px",
                  color: "#6b7280",
                }}
              >
                Auto-launching in a few seconds‚Ä¶
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MAIN APP CONTENT */}
      <div
        style={{
          maxWidth: "1200px",
          margin: "0 auto",
          filter: showLanding ? "blur(3px)" : "none",
          transition: "filter 400ms ease",
        }}
      >
        {/* TOP BAR */}
        <header style={topBarStyle}>
          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
            <div style={{ width: 40, height: 40 }}>
              <DotLottieReact
                src="https://lottie.host/5a79cff1-423a-4aa6-824f-954dca862994/ezy8pcAi40.lottie"
                loop
                autoplay
                style={{ width: "40px", height: "40px" }}
              />
            </div>
            <div style={{ fontSize: 24, fontWeight: 700 }}>
              BoulderMove ‚Äì Smart Trip Dashboard
            </div>
          </div>

          <div style={{ fontSize: 14, color: "#666" }}>
            {new Date().toLocaleString()}
          </div>
        </header>
        {/* MAIN GRID */}
        <main style={mainLayoutStyle}>
          {/* LEFT PANEL ‚Äì controls */}
          <section style={leftPanelStyle}>
            <h2
              style={{
                fontSize: 16,
                fontWeight: 600,
                marginBottom: 8,
              }}
            >
              Trip setup
            </h2>

            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              {/* ORIGIN */}
              <Autocomplete
                onLoad={(ref) => (originAutoRef.current = ref)}
                onPlaceChanged={() => {
                 const place = originAutoRef.current.getPlace();
                 console.log("üìç ORIGIN PLACE", place);

                 if (!place.geometry || !place.geometry.location) {
                   console.warn("‚ùå No geometry returned for ORIGIN");
                  return;
                  }

                  const coords = {
                   lat: place.geometry.location.lat(),
                   lng: place.geometry.location.lng(),
                  };
                   console.log("üìç ORIGIN COORDS SET", coords);
                   setOriginCoords(coords);
                   }}
	
              >
                <input
                  value={origin}
                  onChange={(e) => setOrigin(e.target.value)}
                  placeholder="Origin"
                  style={inputStyle}
                />
              </Autocomplete>

              {/* STOPS */}
              <Autocomplete
                onLoad={(ref) => (stopsAutoRef.current = ref)}
                onPlaceChanged={handleStopSelect}
              >
                <input
                  value={stops}
                  onChange={(e) => setStops(e.target.value)}
                  placeholder="Stops ‚Äî semicolon separated"
                  style={inputStyleLarge}
                />
              </Autocomplete>

              {/* DESTINATION */}
              <Autocomplete
                onLoad={(ref) => (destAutoRef.current = ref)}
                   onPlaceChanged={() => {
  		     const place = destAutoRef.current.getPlace();
  		     console.log("üìç DEST PLACE", place);

  		     if (!place.geometry || !place.geometry.location) {
    			console.warn("‚ùå No geometry returned for DESTINATION");
    			return;
  			}

  		     const coords = {
    			lat: place.geometry.location.lat(),
    			lng: place.geometry.location.lng(),
  			};
 		      console.log("üìç DEST COORDS SET", coords);
  		      setDestinationCoords(coords);
		     }}
		
              >
                <input
                  value={destination}
                  onChange={(e) => setDestination(e.target.value)}
                  placeholder="Destination"
                  style={inputStyle}
                />
              </Autocomplete>

              {/* MODE SELECT */}
              <select
                value={mode}
                onChange={(e) => setMode(e.target.value)}
                style={selectStyle}
              >
                <option value="driving">üöó Driving</option>
                <option value="walking">üö∂ Walking</option>
                <option value="bicycling">üö¥ Bicycling</option>
                <option value="transit">üöå Transit</option>
              </select>

              {/* ALTERNATIVES */}
              <label
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "6px",
                  fontSize: 13,
                }}
              >
                <input
                  type="checkbox"
                  checked={showAlternatives}
                  onChange={(e) => setShowAlternatives(e.target.checked)}
                />
                Show alternative routes
              </label>

              {/* WEATHER TOGGLE */}
              <button
                onClick={() => setShowWeatherDetails((prev) => !prev)}
                style={{
                  marginTop: "4px",
                  padding: "8px 12px",
                  borderRadius: "8px",
                  border: "1px solid #ccc",
                  background: "#f7f7f7",
                  cursor: "pointer",
                  fontSize: 13,
                }}
              >
                {showWeatherDetails
                  ? "Hide today‚Äôs weather"
                  : "Show today‚Äôs weather"}
              </button>
            </div>
          </section>

          {/* CENTER PANEL ‚Äì MAP */}
          <section style={centerPanelStyle}>
            <div style={{ fontSize: 14, fontWeight: 500, marginBottom: 6 }}>
              Map view
            </div>

            <div style={mapContainerStyle}>
              {isLoaded ? (
                <GoogleMap
                  key={
                    origin + destination + stops + mode + showAlternatives
                  }
                  onLoad={(map) => (mapRef.current = map)}
                  zoom={10}
                  center={{ lat: 39.5, lng: -98.35 }}
                  mapContainerStyle={{ width: "100%", height: "100%" }}
                  options={mapOptions}
                >
                  {/* ROUTE POLYLINES */}
                  {decodedRoutes.map((path, i) => (
                    <Polyline
                      key={i}
                      path={path}
                      options={{
                        strokeColor: [
                          "#4285F4",
                          "#FF6347",
                          "#2ECC71",
                          "#8E44AD",
                        ][i % 4],
                        strokeWeight: i === 0 ? 6 : 4,
                        strokeOpacity: i === 0 ? 1 : 0.7,
                      }}
                    />
                  ))}

                  {/* MARKERS */}
                  {buildMarkers().map((m, index) => (
                    <Marker
                      key={index}
                      position={m.position}
                      label={String.fromCharCode(65 + index)}
                    />
                  ))}
                </GoogleMap>
              ) : (
                <div style={{ textAlign: "center", padding: "200px 0" }}>
                  Loading map...
                </div>
              )}
            </div>
          </section>

          {/* RIGHT PANEL ‚Äì route insights */}
          <section style={rightPanelStyle}>
            <h2
              style={{
                fontSize: 16,
                fontWeight: 600,
                marginBottom: 6,
              }}
            >
              Route options
            </h2>

            <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
              <button style={chipStyle}>Best on-time</button>
              <button style={chipStyle}>Shortest</button>
              <button style={chipStyle}>Fewest transfers</button>
            </div>
            {/* ROUTE LIST */}
            {routes.length === 0 ? (
              <div style={{ fontSize: 13, color: "#777" }}>
                Enter origin and destination to see route suggestions.
              </div>
            ) : (
              routes.map((r, i) => (
                <RouteCard
                  key={i}
                  route={r}
                  index={i}
                  mode={mode}
                  showWeatherDetails={showWeatherDetails}
                />
              ))
            )}
          </section>
        </main>

        {/* BOTTOM SUMMARY */}
        <footer style={bottomStripStyle}>
          {routes.length > 0 ? (
            <>
              <strong>Summary:</strong> Fastest route is{" "}
              {routes[0].duration_min} min and {routes[0].distance_km} km.{" "}
              {routes[0].weather && (
                <>
                  Current weather at origin: {routes[0].weather.temp} ¬∞C,{" "}
                  {routes[0].weather.weather_main}.
                </>
              )}
            </>
          ) : (
            <>Ready when you are ‚Äî set up a trip to see predictions.</>
          )}
        </footer>
      </div>
    </div>
  );
}

/* -------------------------------------------------------------------------- */
/*                               RouteCard                                     */
/* -------------------------------------------------------------------------- */

function RouteCard({ route, index, mode, showWeatherDetails }) {
  const label = String.fromCharCode(65 + index);
  const color = ["#4285F4", "#FF6347", "#2ECC71", "#8E44AD"][index % 4];

  // weather icon
  let icon = "üå§Ô∏è";
  if (route.weather?.weather_main) {
    const main = route.weather.weather_main.toLowerCase();
    if (main.includes("rain")) icon = "üåßÔ∏è";
    else if (main.includes("snow")) icon = "‚ùÑÔ∏è";
    else if (main.includes("storm") || main.includes("thunder")) icon = "‚õàÔ∏è";
    else if (main.includes("cloud")) icon = "‚òÅÔ∏è";
    else if (main.includes("clear")) icon = "‚òÄÔ∏è";
  }

  // impact level
  const alerts = route.alerts?.custom_alerts || [];
  let impactLevel = "low";
  if (alerts.some((a) => a.severity === "high")) impactLevel = "high";
  else if (alerts.some((a) => a.severity === "medium")) impactLevel = "medium";

  const impactLabel =
    impactLevel === "high"
      ? "High impact"
      : impactLevel === "medium"
      ? "Moderate impact"
      : "Low impact";

  return (
    <div
      style={{
        marginBottom: "8px",
        padding: "10px 12px",
        borderRadius: "10px",
        border: "1px solid #ddd",
        background: "#fafafa",
        fontSize: "14px",
      }}
    >
      {/* Route basics */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 4,
        }}
      >
        <b style={{ color }}>
          Route {label} ‚Äî {route.summary}
        </b>
      </div>

      <div>
        {route.duration_min} min ‚Ä¢ {route.distance_km} km
      </div>
      <div style={{ color: "#666" }}>
        Stops: {route.stops?.join(" ‚Üí ") || "None"}
      </div>
      <div style={{ color: "#666" }}>Mode: {mode}</div>

      {/* Weather card */}
      {showWeatherDetails && (
        <>
          {route.weather ? (
            <div className="weather-card">
              <div className="weather-card-header">
                <div className="weather-main">
                  <span className="weather-icon">{icon}</span>
                  <div>
                    <div className="weather-main-title">
                      {route.weather.temp} ¬∞C ¬∑ {route.weather.weather_main}
                    </div>
                    <div className="weather-main-sub">
                      {route.weather.weather_desc}
                    </div>
                  </div>
                </div>
                <span className={"impact-badge impact-" + impactLevel}>
                  {impactLabel}
                </span>
              </div>

              {/* Row 1 */}
              <div className="weather-metrics-row">
                <div className="weather-metric">
                  <span className="weather-metric-emoji">üå°Ô∏è</span>
                  <span>{route.weather.feels_like} ¬∞C feels like</span>
                </div>

                <div className="weather-metric">
                  <span className="weather-metric-emoji">üíß</span>
                  <span>{route.weather.humidity}% humidity</span>
                </div>

                <div className="weather-metric">
                  <span className="weather-metric-emoji">üå¨Ô∏è</span>
                  <span>{route.weather.wind_speed} m/s wind</span>
                </div>
              </div>

              {/* Row 2 */}
              <div className="weather-metrics-row">
                <div className="weather-metric">
                  <span className="weather-metric-emoji">üåßÔ∏è</span>
                  <span>{route.weather.rain_1h ?? 0} mm rain (last hour)</span>
                </div>

                <div className="weather-metric">
                  <span className="weather-metric-emoji">‚ùÑÔ∏è</span>
                  <span>{route.weather.snow_1h ?? 0} mm snow (last hour)</span>
                </div>
              </div>
            </div>
          ) : (
            <div style={{ marginTop: "6px", fontSize: "13px", color: "#555" }}>
              Weather data unavailable for this route.
            </div>
          )}
        </>
      )}

      {/* Alerts */}
      {renderAlerts(route.alerts?.custom_alerts)}
      {renderEvents(route.events_nearby)}
    </div>
  );
}

/* -------------------------------------------------------------------------- */
/*                               ALERTS RENDER                                 */
/* -------------------------------------------------------------------------- */

const severityColors = {
  high: "#ffe5e5",
  medium: "#fff5d6",
  low: "#e5ffe5",
};

const renderAlerts = (alerts) => {
  if (!alerts || alerts.length === 0) {
    return (
      <div style={{ marginTop: "4px", fontSize: "13px", color: "#555" }}>
        No weather alerts for this route.
      </div>
    );
  }

  return alerts.map((a, idx) => (
    <div
      key={idx}
      style={{
        marginTop: "6px",
        padding: "8px 10px",
        borderRadius: "8px",
        border: "1px solid #ddd",
        backgroundColor: severityColors[a.severity] || "#f5f5f5",
        fontSize: "13px",
      }}
    >
      <strong>{a.title}</strong>
      <div style={{ marginTop: "2px" }}>{a.message}</div>
      <div style={{ fontSize: "12px", color: "#777", marginTop: "2px" }}>
        Severity: {a.severity}
      </div>
    </div>
  ));
};
/* -------------------------------------------------------------------------- */
/*                                EVENTS RENDER                               */
/* -------------------------------------------------------------------------- */

const renderEvents = (eventsWrapper) => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const rawEvents = Array.isArray(eventsWrapper)
    ? eventsWrapper
    : eventsWrapper?.events ?? [];

  if (!rawEvents || rawEvents.length === 0) {
    return (
      <div style={{ marginTop: "4px", fontSize: "14px", color: "#555" }}>
        No events near this route.
      </div>
    );
  }

  const groups = new Map();

  for (const e of rawEvents) {
    if (!e.url) continue;

    const name = (e.name || e.title || "Untitled Event").trim();
    const venue = (e.venue_name || e.venue || "").trim();
    const timeStr = e.date_time || e.start_time;
    if (!timeStr) continue;

    const time = new Date(timeStr);
    const eventDate = new Date(time);
    eventDate.setHours(0, 0, 0, 0);

    if (eventDate.getTime() !== today.getTime()) continue;

    const key = `${name.toLowerCase()}::${venue.toLowerCase()}::${eventDate}`;

    if (!groups.has(key)) {
      groups.set(key, {
        base: e,
        showtimes: [],
      });
    }

    groups.get(key).showtimes.push(time);
  }

  let groupedEvents = Array.from(groups.values()).filter(
    (g) => g.showtimes.length > 0
  );

  if (groupedEvents.length === 0) {
    return (
      <div style={{ marginTop: "4px", fontSize: "14px", color: "#555" }}>
        No upcoming ticketed events near this route.
      </div>
    );
  }

  return groupedEvents.map(({ base, showtimes }, idx) => (
    <div
      key={idx}
      style={{
        marginTop: "10px",
        padding: "12px",
        borderRadius: "10px",
        border: "1px solid #cce0ff",
        backgroundColor: "#f0f6ff",
      }}
    >
      {/* Title */}
      <strong style={{ fontSize: "16px", color: "#0055cc" }}>
        {base.name || base.title || "Untitled Event"}
      </strong>

      {/* Link */}
      <div style={{ marginTop: "4px" }}>
        <a
          href={base.url}
          target="_blank"
          rel="noreferrer"
          style={{ color: "#0066ff", textDecoration: "underline" }}
        >
          View Event ‚Üí
        </a>
      </div>

      {/* Showtimes */}
      {showtimes.length > 0 && (
        <div style={{ marginTop: "4px", fontSize: "13px", color: "#333" }}>
          {showtimes.length === 1 ? "Showtime:" : "Showtimes:"}{" "}
          {showtimes.map((t) => t.toLocaleString()).join(" ‚Ä¢ ")}
        </div>
      )}

      {/* Venue */}
      {base.venue_name && (
        <div style={{ fontSize: "13px", color: "#444" }}>
          Venue: {base.venue_name}
        </div>
      )}

      {/* Distance */}
      {base.distance_from_route_m && (
        <div style={{ fontSize: "13px", color: "#777", marginTop: "3px" }}>
          {Math.round(base.distance_from_route_m)} m from route
        </div>
      )}

      {/* Fallback venue */}
      {base.venue && (
        <div style={{ fontSize: "13px", color: "#555", marginTop: "3px" }}>
          Venue: {base.venue}
        </div>
      )}

      {/* Capacity */}
      {base.capacity && (
        <div style={{ fontSize: "13px", color: "#333", marginTop: "3px" }}>
          Capacity: {base.capacity.toLocaleString()}
        </div>
      )}

      {/* Address */}
      {base.address && (
        <div
          style={{
            fontSize: "12px",
            color: "#666",
            marginTop: "4px",
            fontStyle: "italic",
          }}
        >
          {base.address}
        </div>
      )}
    </div>
  ));
};

/* ---------------- END OF FILE ---------------- */
